name: Flutter CI/CD

on:
  push:
    tags:
      - "*"

jobs:
  build_dev:
    runs-on: ubuntu-latest
    steps:
     - uses: actions/checkout@v4

     - uses: actions/setup-java@v3
       with:
         distribution: 'adopt'
         java-version: '17'

     - name: 'Move and decode secrets'
       shell: bash
       run: |
         mkdir -p lib/constants
         echo ${{ secrets.FIREBASE_SECRETS_FILE }} | base64 --decode > lib/constants/secrets.dart
         echo ${{ secrets.BACKEND_TOKEN }} | base64 --decode > lib/constants/token.dart
         mkdir -p android/app
         echo ${{ secrets.COMMON_GOOGLE_SERVICES_JSON }} | base64 --decode > android/app/google-services.json
         mkdir -p android/app/src/prod/res
         echo ${{ secrets.GOOGLE_SERVICES_JSON_PROD_BASE64 }} | base64 --decode > android/app/src/prod/res/google-services.json
         mkdir -p android/app/src/dev/res
         echo ${{ secrets.GOOGLE_SERVICES_JSON_DEV_BASE64 }} | base64 --decode > android/app/src/dev/res/google-services.json
      
     - name: 'Set Flutter 3.22.2'
       uses: subosito/flutter-action@v2
       with:
         flutter-version: '3.22.2'

     - run: flutter pub get

     - run: flutter analyze

     - run: flutter test

     - run: flutter build apk --flavor dev --dart-define=IS_DEV=true

     - uses: actions/upload-artifact@v3
       with:
         name: APK DEV
         path: build/app/outputs/flutter-apk/app-dev-release.apk

     - name: Upload artifact to Firebase App Distribution
       uses: wzieba/Firebase-Distribution-Github-Action@v1
       with:
         appId: ${{ secrets.FIREBASE_APP_ID_DEV }}
         token: ${{ secrets.FIREBASE_TOKEN_DEV }}
         groups: all
         file: build/app/outputs/flutter-apk/app-dev-release.apk
         debug: true

  build_prod:
    runs-on: ubuntu-latest
    steps:
     - uses: actions/checkout@v4

     - uses: actions/setup-java@v3
       with:
         distribution: 'adopt'
         java-version: '17'

     - name: 'Move and decode secrets'
       shell: bash
       run: |
         mkdir -p lib/constants
         echo ${{ secrets.FIREBASE_SECRETS_FILE }} | base64 --decode > lib/constants/secrets.dart
         echo ${{ secrets.BACKEND_TOKEN }} | base64 --decode > lib/constants/token.dart
         mkdir -p android/app
         echo ${{ secrets.COMMON_GOOGLE_SERVICES_JSON }} | base64 --decode > android/app/google-services.json
         mkdir -p android/app/src/prod/res
         echo ${{ secrets.GOOGLE_SERVICES_JSON_PROD_BASE64 }} | base64 --decode > android/app/src/prod/res/google-services.json
         mkdir -p android/app/src/dev/res
         echo ${{ secrets.GOOGLE_SERVICES_JSON_DEV_BASE64 }} | base64 --decode > android/app/src/dev/res/google-services.json

     - name: 'Set Flutter 3.22.2'
       uses: subosito/flutter-action@v2
       with:
         flutter-version: '3.22.2'

     - run: flutter pub get

     - run: flutter analyze

     - run: flutter test

     - run: flutter build apk --flavor prod --dart-define=IS_DEV=false

     - uses: actions/upload-artifact@v3
       with:
         name: APK PROD
         path: build/app/outputs/flutter-apk/app-prod-release.apk

     - name: Upload artifact to Firebase App Distribution
       uses: wzieba/Firebase-Distribution-Github-Action@v1
       with:
         appId: ${{ secrets.FIREBASE_APP_ID_PROD }}
         token: ${{ secrets.FIREBASE_TOKEN }}
         groups: all
         file: build/app/outputs/flutter-apk/app-prod-release.apk
         debug: true